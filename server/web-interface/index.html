<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–¢–µ–ø–ª–∏—Ü–∞ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</title>
  <script src="chart.min.js"></script>
<style>
    body { margin: 0; font-family: Arial, sans-serif; background: #f4faf6; color: #222; }
    header { display: flex; justify-content: space-between; align-items: center; background: #e1f5e5; padding: 0.6em 1em; font-size: 1.2em; font-weight: bold; color: #3a7f5d; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    nav { display: flex; justify-content: center; gap: 1em; background: #d5eee0; padding: 0.5em 0; }
    nav button { padding: 0.5em 1em; border: none; border-radius: 20px; background: #aee3c6; cursor: pointer; font-weight: bold; }
    nav button.active { background: #3eaf7c; color: white; }
    .tabs, .range-switch { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; padding: 10px; }
    .tabs button, .range-switch button {
      padding: 0.4em 0.9em;
      border-radius: 20px;
      border: 1px solid #ccc;
      background: white;
      cursor: pointer;
      font-size: 0.9em;
    }
    .tabs button.active, .range-switch button.active {
      background: #66bb6a;
      color: white;
      border-color: #66bb6a;
    }
    .panel { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; padding: 1em; }
    .card {
      background: white;
      padding: 1em;
      border-radius: 16px;
      min-width: 220px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
      text-align: center;
      position: relative;
    }
    .card-icon {
      font-size: 2em;
    }
    .label { font-size: 1em; color: #555; margin-top: 0.5em; }
    .value { font-size: 1.8em; margin-top: 0.3em; font-weight: bold; }
    .bar {
      height: 6px;
      border-radius: 4px;
      background: #e0e0e0;
      margin-top: 0.5em;
      overflow: hidden;
    }
    .bar-inner {
      height: 100%;
      background: #66bb6a;
    }
    canvas { width: 100% !important; max-height: 280px; margin: 1em auto; transition: opacity 0.2s ease-in-out; }
    table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    th, td { padding: 0.5em; border-bottom: 1px solid #ccc; text-align: center; }
    .section { display: none; }
    #history, #monitor { padding: 1em; }

    #codeInput {
      padding: 0.4em 0.9em;
      border-radius: 20px;
      border: 1px solid #ccc;
      font-size: 1em;
      background: white;
    }

    #setCodeBtn {
      padding: 0.4em 0.9em;
      border-radius: 20px;
      border: none;
      background: #aee3c6;
      cursor: pointer;
      font-weight: bold;
    }

  </style>
</head>
<body>
  <header>
    <div>üåø –¢–µ–ø–ª–∏—Ü–∞</div>
    <div style="display: flex; align-items: center; gap: 0.5em;">
      <label for="codeInput">–ö–æ–¥:</label>
      <input id="codeInput" type="text" maxlength="6" style="padding: 0.3em; font-size: 1em; width: 6em;" />
      <button id="setCodeBtn" onclick="setCode()">OK</button>
      <span id="codeError" style="color: red; font-size: 0.9em;"></span>
    </div>
  </header>
  <nav>
    <button onclick="showSection('monitor')" class="active">–ü–∞–Ω–µ–ª—å</button>
    <button onclick="showSection('history')">–ò—Å—Ç–æ—Ä–∏—è</button>
  </nav>
  <div id="monitor" class="section" style="display:block">
    <div class="panel" id="cards"></div>
    <div class="tabs" id="chartTabs"></div>
    <div class="range-switch" id="chartRangeButtons"></div>
    <canvas id="chartCanvas"></canvas>
  </div>
  <div id="history" class="section">
    <div class="range-switch" id="tableRangeButtons"></div><div class="range-switch" style="margin-top:-8px"><button id="archiveToggle" onclick="toggleArchive()">üìÅ –ê—Ä—Ö–∏–≤</button></div>
    
    <table>
      <thead><tr><th>–î–∞—Ç–∞</th><th>–¢–µ–º–ø. –≤–æ–∑–¥—É—Ö–∞</th><th>–¢–µ–º–ø. –ø–æ—á–≤—ã</th><th>–í–ª–∞–∂–Ω. –≤–æ–∑–¥—É—Ö–∞</th><th>–í–ª–∞–∂–Ω. –ø–æ—á–≤—ã</th><th>–û—Å–≤–µ—â–µ–Ω–Ω–æ—Å—Ç—å</th><th>CO‚ÇÇ</th></tr></thead>
      <tbody id="historyTable"></tbody>
    </table>
  </div>
<script>
function getBarColor(k, percent) {
  if (k.includes('light')) return '#ffeb3b';
  if (k.includes('CO2')) return '#9e9e9e';
  if (percent < 30) return '#f44336';
  if (percent < 70) return '#ff9800';
  return '#66bb6a';
}

const fields = {
  airTemp: '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤–æ–∑–¥—É—Ö–∞ (¬∞C)',
  soilTemp: '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –ø–æ—á–≤—ã (¬∞C)',
  airHum: '–í–ª–∞–∂–Ω–æ—Å—Ç—å –≤–æ–∑–¥—É—Ö–∞ (%)',
  soilMois: '–í–ª–∞–∂–Ω–æ—Å—Ç—å –ø–æ—á–≤—ã (%)',
  lightLevel: '–û—Å–≤–µ—â–µ–Ω–Ω–æ—Å—Ç—å (–ª–∫)',
  CO2ppm: '–£—Ä–æ–≤–µ–Ω—å CO‚ÇÇ (ppm)'
};
const icons = {
  airTemp: 'üå°Ô∏è',
  soilTemp: 'üå°Ô∏è',
  airHum: 'üíß',
  soilMois: 'üíß',
  lightLevel: '‚òÄÔ∏è',
  CO2ppm: 'üå¨Ô∏è'
};
const ranges = ['day', 'week', 'month', 'year'];
let data = [], chart;
let currentField = 'airTemp';
let chartRange = 'day', tableRange = 'day';
let showFullArchive = false;

async function loadData() {
  try {
    const res = await fetch(`data_${greenhouseCode}.json?cachebust=${Date.now()}`);
    if (!res.ok) throw new Error('–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω');
    const text = await res.text();
    data = text.trim().split('\n').map(JSON.parse);
    updateCards();
    updateChartTabs();
    updateCharts();
    updateTable();
  } catch (e) {
    document.getElementById('codeError').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + e.message;
  }
  updateCards();
  updateChartTabs();
  updateCharts();
  updateTable();
}

function groupData(filtered, field, period) {
  const grouped = {};
  filtered.forEach(d => {
    let key = d.date;
    if (period === 'year') key = d.date.slice(3); // MM/YYYY
    if (!grouped[key]) grouped[key] = [];
    grouped[key].push(parseFloat(d[field]));
  });
  return Object.entries(grouped).map(([key, vals]) => ({ label: key, value: +(vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(2) }));
}

function filterByRange(range) {
  if (showFullArchive) return data;

  if (range === 'day') {
    // –ù–∞–π—Ç–∏ –ø–æ—Å–ª–µ–¥–Ω—é—é –¥–æ—Å—Ç—É–ø–Ω—É—é –¥–∞—Ç—É
    const lastDate = data.length ? data[data.length - 1].date : null;
    return data.filter(d => d.date === lastDate);
  }

  const now = new Date();
  const msMap = { week: 6048e5, month: 2592e6, year: 31536e6 };
  const cutoff = now.getTime() - msMap[range];
  return data.filter(d => {
    const [dd, mm, yyyy] = d.date.split('/');
    const t = new Date(`${yyyy}-${mm}-${dd}T${d.time}`).getTime();
    return t >= cutoff;
  });
}


function updateCards() {
  const latest = data[data.length - 1];
  const panel = document.getElementById('cards');
  panel.innerHTML = Object.keys(fields).map(k => {
    let val = latest[k];
    if (k.includes('Temp')) val = parseFloat(val).toFixed(1);
    let max = 100;
if (k.includes('Temp')) max = 45;
if (k.includes('light')) max = 2000;
if (k.includes('CO2')) max = 5000;
const percent = Math.min(100, Math.max(0, (val / max) * 100));
    return `
      <div class="card">
        <div class="card-icon">${icons[k] || ''}</div>
        <div class="label">${fields[k]}</div>
        <div class="value">${val}</div>
        <div class="bar"><div class="bar-inner" style="width:${percent}%; background: ${getBarColor(k, percent)}"></div></div>
      </div>`;
  }).join('');
}
</script>

<button id="themeToggle" style="position: fixed; top: 50px; right: 20px; padding: 0.6em 1.2em; font-size: 1.2em; border-radius: 12px; border: none; background: linear-gradient(135deg, #4caf50, #2e7d32); color: white; cursor: pointer; z-index: 1000; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">üåô</button>
<script>
document.getElementById('themeToggle').onclick = () => {
  document.body.classList.toggle('dark');
  const dark = document.body.classList.contains('dark');
  localStorage.setItem('theme', dark ? 'dark' : 'light');
  document.getElementById('themeToggle').textContent = dark ? '‚òÄÔ∏è' : 'üåô';
};
if (localStorage.getItem('theme') === 'dark') {
  document.body.classList.add('dark');
  document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
}
</script>
<style>
body.dark {
  background: #121212;
  color: #eee;
}
body.dark .card, body.dark table, body.dark canvas, body.dark .range-switch button, body.dark .tabs button {
  background: #1e1e1e;
  color: #ddd;
  border-color: #444;
}
body.dark nav, body.dark header {
  background: #1c2c26;
  color: #aaffcc;
}
body.dark .bar { background: #333; }
body.dark .bar-inner { filter: brightness(1.2); }
body.dark .tabs button.active, body.dark .range-switch button.active {
  background: #66bb6a;
  color: white;
  border-color: #66bb6a;
}
</style>
<!-- –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –∫–æ–¥–∞ —Å —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∏ —Ç–∞–±–ª–∏—Ü –æ—Ç–ø—Ä–∞–≤–ª—é –≤ —Å–ª–µ–¥—É—é—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ -->
<script>
  function updateChartTabs() {
    const container = document.getElementById('chartTabs');
    container.innerHTML = '';
    Object.keys(fields).forEach(key => {
      const btn = document.createElement('button');
      btn.textContent = fields[key];
      btn.className = key === currentField ? 'active' : '';
      btn.onclick = () => {
        currentField = key;
        updateCharts();
        updateChartTabs();
      };
      container.appendChild(btn);
    });
  }
  
  const yAxisRanges = {
  airTemp: [0, 50],
  soilTemp: [0, 50],
  airHum: [0, 100],
  soilMois: [0, 100],
  lightLevel: [0, 2000],
  CO2ppm: [0, 5000]
  };


  function updateCharts() {
    const filtered = filterByRange(chartRange);
    const points = chartRange === 'day' ? 
      filtered.map(d => ({ label: d.time, value: d[currentField] })) :
      groupData(filtered, currentField, chartRange);
    const ctx = document.getElementById('chartCanvas').getContext('2d');
    if (chart) chart.destroy();
    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: points.map(p => p.label),
        datasets: [{
          label: fields[currentField],
          data: points.map(p => p.value),
          borderColor: '#3eaf7c',
          backgroundColor: 'rgba(62, 175, 124, 0.1)',
          tension: 0.4,
          fill: true
        }]
      },
      options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: { duration: 0 },
      scales: {
        y: {
          min: yAxisRanges[currentField][0],
          max: yAxisRanges[currentField][1],
          beginAtZero: false
        }
      }
    }

    });
  }
  
  function updateTable() {
    const filtered = filterByRange(tableRange);
    const tbody = document.getElementById('historyTable');
    if (showFullArchive || tableRange === 'day') {
      tbody.innerHTML = filtered.reverse().map(d => 
        `<tr><td>${d.date} ${d.time}</td><td>${d.airTemp}</td><td>${d.soilTemp}</td><td>${d.airHum}</td><td>${d.soilMois}</td><td>${d.lightLevel}</td><td>${d.CO2ppm}</td></tr>`
      ).join('');
    } else {
      const grouped = {};
      filtered.forEach(d => {
        let key = d.date;
        if (tableRange === 'year') key = d.date.slice(3);
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(d);
      });
      tbody.innerHTML = Object.entries(grouped).map(([key, group]) => {
        const avg = field => {
          const sum = group.reduce((acc, d) => acc + parseFloat(d[field]), 0);
          return (sum / group.length).toFixed(1);
        };
        toFixed(1);
        return `<tr><td>${key}</td><td>${avg('airTemp')}</td><td>${avg('soilTemp')}</td><td>${avg('airHum')}</td><td>${avg('soilMois')}</td><td>${avg('lightLevel')}</td><td>${avg('CO2ppm')}</td></tr>`;
      }).reverse().join('');
    }
  }
  
  function createRangeButtons(containerId, current, onClick) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    ranges.forEach(r => {
      const btn = document.createElement('button');
      btn.textContent = r === 'day' ? '–î–µ–Ω—å' : r === 'week' ? '–ù–µ–¥–µ–ª—è' : r === 'month' ? '–ú–µ—Å—è—Ü' : '–ì–æ–¥';
      btn.className = r === current ? 'active' : '';
      btn.onclick = () => {
        onClick(r);
        createRangeButtons(containerId, r, onClick);
      };
      container.appendChild(btn);
    });
  }
  
  function toggleArchive() {
    showFullArchive = !showFullArchive;
    document.getElementById('archiveToggle').textContent = showFullArchive ? '–°–∫—Ä—ã—Ç—å –∞—Ä—Ö–∏–≤' : '–ü–æ–∫–∞–∑–∞—Ç—å –≤–µ—Å—å –∞—Ä—Ö–∏–≤';
    updateTable();
  }
  
  function showSection(id) {
    document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
    document.getElementById(id).style.display = 'block';
    document.getElementById('section').textContent = id === 'monitor' ? '–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥' : '–ò—Å—Ç–æ—Ä–∏—è';
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
    document.querySelector(`nav button[onclick*="${id}"]`).classList.add('active');
  }
  
  createRangeButtons('chartRangeButtons', chartRange, (r) => { chartRange = r; updateCharts(); });
  createRangeButtons('tableRangeButtons', tableRange, (r) => { tableRange = r; updateTable(); });
  
  let greenhouseCode = localStorage.getItem('greenhouseCode') || 'A1B2C3';

  function setCode() {
    const input = document.getElementById('codeInput');
    const code = input.value.trim();
    const error = document.getElementById('codeError');
    
    if (!/^[A-Za-z0-9]{6}$/.test(code)) {
      error.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ (—Ç–æ–ª—å–∫–æ 6 –±—É–∫–≤/—Ü–∏—Ñ—Ä)';
      return;
    }

    error.textContent = '';
    localStorage.setItem('greenhouseCode', code);
    greenhouseCode = code;
    loadData();
  }

  if (greenhouseCode) {
    document.getElementById('codeInput').value = greenhouseCode;
    loadData();
  }

  </script>
  </body>
  </html>
  